<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>修改密码</title>
    <link rel="stylesheet" href="lib/weui/style/weui.min.css">
    <style>
    </style>
</head>

<body>
    <div class="container">
        <form id="passwd-fm">
            <div class="weui_cells weui_cells_form">
                <div class="weui_cell">
                    <div class="weui_cell_hd">
                        <label class="weui_label">原密码</label>
                    </div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input" type="password" name="login_pwd" placeholder="请输入原密码" required="required">
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd">
                        <label class="weui_label">验证码</label>
                    </div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input" type="number" name="captcha" placeholder="请输入验证码" required="required">
                    </div>
                    <div class="weui_cell_ft">
                        <a href="javascript:;" class="weui_btn weui_btn_mini weui_btn_default" onclick="getSmsCaptcha(this)">获取验证码</a>
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd">
                        <label class="weui_label">新密码</label>
                    </div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input" type="password" name="new_login_pwd" placeholder="请输入新密码" required="required">
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd">
                        <label class="weui_label">确认新密码</label>
                    </div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input" type="password" name="new_login_pwd2" placeholder="请输入新密码" required="required">
                    </div>
                </div>
            </div>
            <input type="submit" class="weui_btn weui_btn_primary" value="提交">
        </form>
    </div>
    <script type="text/javascript" src="lib/zepto/zepto.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="lib/md5.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="lib/des.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/tool.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script>
    	var g_login_name;
    	
        $(function() {
        	send('/action/user/view', {}, function (data) {
	            if (data.errcode == 0) {
	            	g_login_name = data.data.login_name;
	            }
	        });
        	
            $('#passwd-fm').submit(function(e) {
                e.preventDefault();
                var data = $(this).serializeObject();
                
                if(data.new_login_pwd != data.new_login_pwd2) {
                	alert('两次输入的新密码不一致');
                	return false;
                }
                
				var new_login_pwd = data.new_login_pwd;
                
				data.login_pwd = md5(g_login_name+data.login_pwd);
		        data.new_login_pwd = md5(g_login_name+data.new_login_pwd);
		        data.new_login_pwd = des_ecb_encrypt(data.login_pwd, data.new_login_pwd)
				data.login_pwd = md5(data.login_pwd + data.captcha);
				
				send('/action/user/change-passwd', data, function(data) {
					if(data.errcode == 0) {
						window.localStorage.setItem('app.login_pwd', new_login_pwd);
						window.location.href = 'msg.html';
					}
				});
            });
        });
        
        function des_ecb_encrypt(key, val) {
	    	var ev, i;
	                      
	         ev = '';
	         for(i = 0; i < 32; i +=8) {
	         	ev += des(key.substr(i, 8), val.substr(i,8), 1);
	         }
			 return stringToHex(ev).substr(2);
	    }
        
        function getSmsCaptcha(target) {        	
        	if($(target).hasClass('weui_btn_disabled')) {
        		return false;
        	}
        	var data = $('#passwd-fm').serializeObject();
        	
		    if (!data.login_pwd) {
		        alert('请输入原密码');
        		return false;
		    } 
        	
        	var secord = 59;
        	var timer = setInterval(function() {
        		secord --;        		
        		$(target).text('重新获取(' + secord + 's)');
        		if(secord == 0) {
        			clearInterval(timer);
        			$(target).removeClass('weui_btn_disabled').text('重新获取');
        		}
        	}, 1000);
        	$(target).addClass('weui_btn_disabled').text('重新获取(' + secord + 's)');
        	
        	 send('/action/user/change-passwd/sms-captcha', {}, function(data) {
                if (data.errcode == 0) {
                   $('#tip').text('验证码已经发送到您的手机，请注意查收');
                }
            });
        }
        
    </script>
</body>

</html>