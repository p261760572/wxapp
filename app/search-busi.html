<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>业务申请查询</title>
    <link rel="stylesheet" href="lib/weui/style/weui.min.css">
    <link rel="stylesheet" href="lib/weui/weui-extend.css">
    <style>
        body,
        html {
            height: 100%;
        }
    </style>
</head>

<body>

    <div class="weui_search_bar" id="search_bar">
        <form class="weui_search_outer" id="search-fm">
            <div class="weui_search_inner">
                <i class="weui_icon_search"></i>
                <input type="search" name="search" class="weui_search_input" id="search_input" placeholder="搜索" />
                <a href="javascript:" class="weui_icon_clear" id="search_clear"></a>
            </div>
            <label for="search_input" class="weui_search_text" id="search_text">
                <i class="weui_icon_search"></i>
                <span>支持联系人、开户行、装机地址</span>
            </label>
        </form>
        <a href="javascript:" class="weui_search_cancel" onclick="searchCancel()">取消</a>
    </div>

    <div class="weui_cells weui_cells_access" id="busi-list">
        <!--
        	<a class="weui_cell" href="javascript:;">
	          <div class="weui_cell_bd weui_cell_primary">
	            <p>联系人 联系电话</p>
	          </div>
	          <div class="weui_cell_ft">处理状态</div>
	        </a>
            <div class="weui_media_box weui_media_text">
                <h4 class="weui_media_title">联系人 联系电话 处理状态</h4>
                <p class="weui_media_desc">开户行名称 装机详细地址</p>
                <ul class="weui_media_info">
                    <li class="weui_media_info_meta">申请时间</li>
                    <li class="weui_media_info_meta weui_media_info_meta_extra">备注</li>
                </ul>
            </div>
            -->
    </div>
    <div class="weui-infinite-scroll" id="infinite">
        <div class="infinite-preloader"></div>
        正在加载...
    </div>

    <script type="text/javascript" src="lib/template.js" charset="utf-8"></script>
    <script type="text/javascript" src="lib/zepto/zepto.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="lib/weui/weui.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/tool.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script id="list-templ" type="text/html">
        {{each rows as row i}}
        <a class="weui_cell" href="javascript:;" data-index="{{i}}">
            <div class="weui_cell_bd weui_cell_primary">
                <p>{{row.linkman}} {{row.tel_no}} </p>
            </div>
            <div class="weui_cell_ft" style="color:#f6383a;">{{row.proc_st | formatProcSt}}</div>
        </a>
        <div class="weui_media_box weui_media_text">
            <div class="weui_media_desc">{{row.subbranch_name}}</div>
            <div class="weui_media_desc">{{row.installed_addr}}</div>
            <div class="weui_media_desc">{{row.remark}} </div>
            <div class="weui_media_desc" style="color:#f6383a;">{{row.checked_reason}}</div>
            <ul class="weui_media_info">
                <li class="weui_media_info_meta">{{row.created_time}}</li>
                <li class="weui_media_info_meta weui_media_info_meta_extra">{{row.created_by}}</li>
                {{if row.apptype=='109'}}
                <li class="weui_media_info_meta weui_media_info_meta_extra">当面付</li>
                {{/if}}
            </ul>
        </div>
        {{/each}}
    </script>
    <script>
        var procStData = [{
            "text": "暂存",
            "value": "1"
        }, {
            "text": "已提交",
            "value": "2"
        }, {
            "text": "待完善",
            "value": "3"
        }, {
            "text": "已处理",
            "value": "4"
        }, {
            "text": "审核通过",
            "value": "8"
        }, {
            "text": "审核不通过",
            "value": "9"
        }, {
            "text": "已派单",
            "value": "A"
        }, {
            "text": "装机中",
            "value": "B"
        }, {
            "text": "已装机",
            "value": "C"
        }];


        var query = {
            page: 1,
            rows: 10
        };
        var loading = false; //状态标记

        template.helper('formatProcSt', function(proc_st) {
            return formatField(procStData, proc_st);
        });

        $(function() {
            $('#search-fm').submit(submitSearch).submit();
        });

        function showActions(target, rows) {
        	var index = $(target).attr('data-index');
        	var row = rows[index];
            var apptype = row.apptype;
            var params = $.param({
                apppay_id: row.apppay_id
            });
            
            var page = 'acq-busi.html';
            if(row.apptype == '109') {
            	page = 'dmf-busi.html';
            }
            
            var actions = [{
                text: "查看",
                className: "color-primary",
                onClick: function() {
                    window.location.href = page + '?operateType=view&' + params;
                }
            }];

            if (row.proc_st == '3') {
                actions.push({
                    text: "编辑",
                    className: "color-danger",
                    onClick: function() {
                        window.location.href = page + '?operateType=update&' + params;
                    }
                });
            }

            $.actions({
                actions: actions
            });
        }

        function submitSearch(e) {
            e.preventDefault();
            var data = $(this).serializeObject();
            $.extend(query, data);
            query.page = 1;
            searchBusi();
        }

        function searchCancel() {
            query.search = null;
            query.page = 1;
            searchBusi();
        }

        function searchBusi() {
            if (query.page == 1) {
                $('#infinite').show();
                $(document.body).infinite(1).on("infinite", function() {
                    if (loading) return;
                    loading = true;
                    query.page++;
                    searchBusi();
                });
            }
            send('/action/ms/mchnt-busi/search', query, function(data) {
                if (data.errcode == 0) {
                    var html = template('list-templ', data);
                    if (query.page == 1) {
                        $('#busi-list').html(html);
                    } else {
                        $('#busi-list').append(html);
                    }
                    $('a.weui_cell').off('click').on('click', function() {
                        showActions(this, data.rows);
                    });

                    loading = false;

                    if (data.rows.length < query.rows) {
                        $(document.body).destroyInfinite();
                        $('#infinite').hide();
                    }
                }
            });
        }
    </script>
</body>

</html>