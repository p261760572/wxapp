<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>绑定设备</title>
<link rel="stylesheet" href="../../lib/weui/style/weui.min.css">
<link rel="stylesheet" href="../../lib/weui/weui-extend.css">
<style></style>
</head>
<body>
<div class="container">
  <form id="detail-fm">
    <input type="hidden" name="rec_id">
    <input type="hidden" name="term_no">
    <!-- <div class="weui-cells_title">收单业务申请</div> -->
    <div class="weui-cells weui-cells_access weui-cells_form">
      <div class="weui-cell">
        <!-- <div class="weui-cell__hd"><label class="weui-label">工商营业执照编码</label></div> -->
        <div class="weui-cell__bd weui-cell_primary">
          <p>工作单号</p>
          <input name="work_order_no" type="text" class="weui-input" placeholder="" readonly>
        </div>
      </div>
      <a id="term-busi-list" class="weui-cell">
        <div class="weui-cell__bd weui-cell_primary">
          <p>门店名称</p>
          <p id="shop_name"></p>
          <!--<input name="shop_name" type="text" class="weui-input" readonly>-->
        </div>
        <div class="weui-cell__ft"></div>
      </a>
      <div class="weui-cell">
        <!-- <div class="weui-cell__hd"><label class="weui-label">工商执照有效期</label></div> -->
        <div class="weui-cell__bd weui-cell_primary">
          <p>工作单类型</p>
          <input name="work_order_type" type="text" class="weui-input" placeholder="" readonly>
        </div>
      </div>
      <div class="weui-cell">
        <!-- <div class="weui-cell__hd"><label class="weui-label">组织机构代码证</label></div> -->
        <div class="weui-cell__bd weui-cell_primary">
          <p>工作单内容</p>
          <input name="work_flag" type="text" class="weui-input" placeholder="" readonly>
        </div>
      </div>
      <div class="weui-cell">
        <!-- <div class="weui-cell__hd"><label class="weui-label">主机序列号</label></div> -->
        <div class="weui-cell__bd weui-cell_primary">
          <p>主机序列号</p>
          <input name="zj_device_no" type="text" class="weui-input" id="zj_device_no" placeholder="请输入主机序列号">
        </div>
        <div class="weui-cell__ft">
          <a href="javascript:;" class="weui-btn weui-btn_plain_primary" onclick="onClickScanQRCode('zj_device_no')">扫一扫</a>
        </div>
      </div>
      <div class="weui-cell">
        <!-- <div class="weui-cell__hd"><label class="weui-label">键盘序列号</label></div> -->
        <div class="weui-cell__bd weui-cell_primary">
          <p>键盘序列号</p>
          <input name="jp_device_no" type="text" class="weui-input" id="jp_device_no" placeholder="请输入键盘序列号">
        </div>
        <div class="weui-cell__ft">
          <a href="javascript:;" class="weui-btn weui-btn_plain_primary" onclick="onClickScanQRCode('jp_device_no')">扫一扫</a>
        </div>
      </div>
      <div class="weui-cell">
        <!-- <div class="weui-cell__hd"><label class="weui-label">附件序列号</label></div> -->
        <div class="weui-cell__bd weui-cell_primary">
          <p>附件序列号</p>
          <input name="fj1_device_no" type="text" class="weui-input" id="fj1_device_no" placeholder="请输入附件序列号">
        </div>
        <div class="weui-cell__ft">
          <a href="javascript:;" class="weui-btn weui-btn_plain_primary" onclick="onClickScanQRCode('fj1_device_no')">扫一扫</a>
        </div>
      </div>
    </div>
    <input type="submit" class="weui-btn weui-btn_primary" value="提交">
  </form>
</div>
<script type="text/javascript" src="../../lib/zepto/zepto.min.js" charset="utf-8"></script>
<script type="text/javascript" src="../../lib/weui/weui.min.js" charset="utf-8"></script>
<script type="text/javascript" src="../../js/tool.js" charset="utf-8"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
	var workOrderTypeData = [{
        "text": "装机单",
        "value": "1"
    }, {
        "text": "维护单",
        "value": "2"
    }, {
        "text": "巡检单",
        "value": "3"
    }];
        
	var query = parseQueryString();
	requiredWx();
	$(function () {
		loadDetail(query);
		$('#detail-fm').submit(submitDetail);
	});
	
	function submitDetail(e) {
        e.preventDefault();
        var data = $(this).serializeObject();

        send('/action/ms/workorder/bind-device', data, function(data) {
            if (data.errcode == 0) {
                window.location.href = 'msg.html';
            }
        });
    }

    function loadDetail(query) {
        if (!query.work_order_no) {
            return false;
        }
        send('/action/ms/workorder/view', query, function(data) {
            if (data.errcode == 0) {
            	var container = $('#order-photo');

                data.data.work_order_type = formatField(workOrderTypeData, data.data.work_order_type);
                data.data.work_flag = formatWorkFlag(data.data.work_flag);
                load('#detail-fm', data.data);
				$('#shop_name').text(data.data.shop_name);
				$('#term-busi-list').attr('href', 'term-busi-list.html?term_no=' + data.data.term_no);
            }
        });
    }
    
    function formatWorkFlag(value) {
        var flag = ['装机', '调单', '移机', '培训', '其它', '换机'];
        var work_flag = [],
            i;

        for (i = 0; i < value.length; i++) {
            if (value.charAt(i) == '1') {
                work_flag.push(flag[i]);
            }
        }

        return work_flag.join(',');
    }
	
	function onClickScanQRCode(id) {
		wx.scanQRCode({
			needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
			scanType: ["barCode"], // 可以指定扫二维码还是一维码，默认二者都有
			success: function (res) {
				var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
				var index = result.indexOf(",");
				if(index >= 0) {
					result = result.substr(index+1);
				}
				$('#'+id).val(result);
			},
			fail: function (res) {
				alert(JSON.stringify(res));
			}
		});
	}

</script>
</body>
</html>