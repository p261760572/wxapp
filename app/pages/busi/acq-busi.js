var district = [{ "text": "湖南省", "items": [{ "text": "长沙市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "芙蓉区", "value": "02" }, { "text": "天心区", "value": "03" }, { "text": "岳麓区", "value": "04" }, { "text": "开福区", "value": "05" }, { "text": "雨花区", "value": "11" }, { "text": "望城区", "value": "12" }, { "text": "长沙县", "value": "21" }, { "text": "宁乡县", "value": "24" }, { "text": "浏阳市", "value": "81" }], "value": "01" }, { "text": "株洲市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "荷塘区", "value": "02" }, { "text": "芦淞区", "value": "03" }, { "text": "石峰区", "value": "04" }, { "text": "天元区", "value": "11" }, { "text": "株洲县", "value": "21" }, { "text": "攸县", "value": "23" }, { "text": "茶陵县", "value": "24" }, { "text": "炎陵县", "value": "25" }, { "text": "醴陵市", "value": "81" }], "value": "02" }, { "text": "湘潭市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "雨湖区", "value": "02" }, { "text": "岳塘区", "value": "04" }, { "text": "湘潭县", "value": "21" }, { "text": "湘乡市", "value": "81" }, { "text": "韶山市", "value": "82" }], "value": "03" }, { "text": "衡阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "珠晖区", "value": "05" }, { "text": "雁峰区", "value": "06" }, { "text": "石鼓区", "value": "07" }, { "text": "蒸湘区", "value": "08" }, { "text": "南岳区", "value": "12" }, { "text": "衡阳县", "value": "21" }, { "text": "衡南县", "value": "22" }, { "text": "衡山县", "value": "23" }, { "text": "衡东县", "value": "24" }, { "text": "祁东县", "value": "26" }, { "text": "耒阳市", "value": "81" }, { "text": "常宁市", "value": "82" }], "value": "04" }, { "text": "邵阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "双清区", "value": "02" }, { "text": "大祥区", "value": "03" }, { "text": "北塔区", "value": "11" }, { "text": "邵东县", "value": "21" }, { "text": "新邵县", "value": "22" }, { "text": "邵阳县", "value": "23" }, { "text": "隆回县", "value": "24" }, { "text": "洞口县", "value": "25" }, { "text": "绥宁县", "value": "27" }, { "text": "新宁县", "value": "28" }, { "text": "城步苗族自治县", "value": "29" }, { "text": "武冈市", "value": "81" }], "value": "05" }, { "text": "岳阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "岳阳楼区", "value": "02" }, { "text": "云溪区", "value": "03" }, { "text": "君山区", "value": "11" }, { "text": "岳阳县", "value": "21" }, { "text": "华容县", "value": "23" }, { "text": "湘阴县", "value": "24" }, { "text": "平江县", "value": "26" }, { "text": "汨罗市", "value": "81" }, { "text": "临湘市", "value": "82" }], "value": "06" }, { "text": "常德市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "武陵区", "value": "02" }, { "text": "鼎城区", "value": "03" }, { "text": "安乡县", "value": "21" }, { "text": "汉寿县", "value": "22" }, { "text": "澧县", "value": "23" }, { "text": "临澧县", "value": "24" }, { "text": "桃源县", "value": "25" }, { "text": "石门县", "value": "26" }, { "text": "津市市", "value": "81" }], "value": "07" }, { "text": "张家界市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "永定区", "value": "02" }, { "text": "武陵源区", "value": "11" }, { "text": "慈利县", "value": "21" }, { "text": "桑植县", "value": "22" }], "value": "08" }, { "text": "益阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "资阳区", "value": "02" }, { "text": "赫山区", "value": "03" }, { "text": "南县", "value": "21" }, { "text": "桃江县", "value": "22" }, { "text": "安化县", "value": "23" }, { "text": "沅江市", "value": "81" }], "value": "09" }, { "text": "郴州市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "北湖区", "value": "02" }, { "text": "苏仙区", "value": "03" }, { "text": "桂阳县", "value": "21" }, { "text": "宜章县", "value": "22" }, { "text": "永兴县", "value": "23" }, { "text": "嘉禾县", "value": "24" }, { "text": "临武县", "value": "25" }, { "text": "汝城县", "value": "26" }, { "text": "桂东县", "value": "27" }, { "text": "安仁县", "value": "28" }, { "text": "资兴市", "value": "81" }], "value": "10" }, { "text": "永州市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "零陵区", "value": "02" }, { "text": "冷水滩区", "value": "03" }, { "text": "祁阳县", "value": "21" }, { "text": "东安县", "value": "22" }, { "text": "双牌县", "value": "23" }, { "text": "道县", "value": "24" }, { "text": "江永县", "value": "25" }, { "text": "宁远县", "value": "26" }, { "text": "蓝山县", "value": "27" }, { "text": "新田县", "value": "28" }, { "text": "江华瑶族自治县", "value": "29" }], "value": "11" }, { "text": "怀化市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "鹤城区", "value": "02" }, { "text": "中方县", "value": "21" }, { "text": "沅陵县", "value": "22" }, { "text": "辰溪县", "value": "23" }, { "text": "溆浦县", "value": "24" }, { "text": "会同县", "value": "25" }, { "text": "麻阳苗族自治县", "value": "26" }, { "text": "新晃侗族自治县", "value": "27" }, { "text": "芷江侗族自治县", "value": "28" }, { "text": "靖州苗族侗族自治县", "value": "29" }, { "text": "通道侗族自治县", "value": "30" }, { "text": "洪江市", "value": "81" }], "value": "12" }, { "text": "娄底市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "娄星区", "value": "02" }, { "text": "双峰县", "value": "21" }, { "text": "新化县", "value": "22" }, { "text": "冷水江市", "value": "81" }, { "text": "涟源市", "value": "82" }], "value": "13" }, { "text": "湘西土家族苗族自治州", "items": [{ "text": "吉首市", "value": "01" }, { "text": "泸溪县", "value": "22" }, { "text": "凤凰县", "value": "23" }, { "text": "花垣县", "value": "24" }, { "text": "保靖县", "value": "25" }, { "text": "古丈县", "value": "26" }, { "text": "永顺县", "value": "27" }, { "text": "龙山县", "value": "30" }], "value": "31" }], "value": "43" }];

var query = $$.parseQueryString();
query.operateType = query.operateType || 'create';
requiredWx(function() {

    if (query.operateType == 'create') {
        wxLocation(function(res) {
            var point = new BMap.Point(res.longitude, res.latitude); // 创建坐标点
            var convertor = new BMap.Convertor();
            convertor.translate([point], 3, 5, function(data) {
                if (data.status === 0) {
                    // 根据坐标得到地址描述
                    var myGeo = new BMap.Geocoder();
                    myGeo.getLocation(data.points[0], function(result) {
                        var addComp = result.addressComponents;
                        $('#district').val(addComp.province + ' ' + addComp.city + ' ' + addComp.district);
                        $('#installed_addr').val(addComp.street + addComp.streetNumber);
                    });
                }
            });
        });
    }
});

function searchSubbrach() {
    var processing = false;
    var data = $(this).serializeObject();
    $('#subbranch-list').html('');
    $('#subbranch-list').pagination({
        url: $$.wrapUrl('/action/ms/bank-subbranch/list'),
        pageNumber: 1,
        queryParams: data,
        onLoadSuccess: function(data) {
            processing = false;
            var html = template('subbranch-templ', data);
            $('#subbranch-list').append(html);
        },
        onLoadError: function() {
            processing = false;
        }
    })

    $('#infinite').infinite().on('infinite', function() {
        if (!processing) {
            processing = true;
            $('#subbranch-list').pagination('next');
        }
    });;
}


function serializeDetailForm() {
    var data = $('#detail-fm').serializeObject();
    data.apptype = '105';
    data.license_no = data.license_no.toUpperCase();

    //照片处理
    var images = [];
    $('#detail-fm').find('.weui-uploader__files').each(function(i, element) {
        var type = $(element).attr('id');
        var container = $(element).children('.weui-uploader__file').each(function(i, element) {
            var fileData = $(element).data('file');
            images.push($.extend(fileData, {
                'ei_type': type
            }));
        });
    });

    data.images = images;

    return data;
}


function loadDetailForm(data) {
    //图片
    $('#detail-fm').find('.weui-uploader__files').each(function(i, element) {
        $(element).html('');
    });

    var images = data.images;
    $.each(images, function(index, item) {
        var file = $(template('uploader-file-templ', item)).data('file', item);
        $('#' + item.ei_type).append(file);
    });

    $('#detail-fm').form('load', data.data);
}

function hasImage(images, ei_type) {
    for (var i = 0; i < images.length; i++) {
        if (images[i].ei_type == ei_type) {
            return true;
        }
    }
    return false;
}


function saveDetail() {
    var data = serializeDetailForm();
    var images = data.images;
    delete data.images;

    $$.setData('detail', {
        data: data,
        images: images
    });
    $.toast('show', '暂存成功');
}


function submitDetail() {
    if (!$('#detail-fm').form('validate')) {
        return false;
    }

    var data = serializeDetailForm();

    if (!hasImage(data.images, '01')) {
        $.toast('show', '请上传营业执照照片');
        return false;
    }

    if (!hasImage(data.images, '03')) {
        $.toast('show', '请上传法人身份证照片');
        return false;
    }

    if (!hasImage(data.images, '16')) {
        $.toast('show', '请上传结算账户(银行卡)照片');
        return false;
    }

    var url = '/action/ms/mchnt-busi/' + query.operateType;

    $$.request(url, data, function(data) {
        if (data.errcode == 0) {
            $$.removeData('detail');
            $.toast('show', {
                iconCls: 'weui-icon-success-no-circle',
                callback: function() {
                    history.back();
                }
            });
        }
    });
}


function uploadImage(sourceType, files) {
    var data = {};
    wxChooseImage(sourceType, function(localId) {
        data.localid = localId;
        $.toast('showLoading', {
            msg: '获取地理位置'
        });
        wxLocation(function(res) {
            $.toast('hideLoading');
            $.extend(data, res);
            wxUploadImage(localId, function(serverId) {
                data.serverid = serverId;
                data.app_created_time = $$.formatDate(new Date(), 'yyyyMMddhhmmss');
                //生成html,存储
                $(template('uploader-file-templ', data)).appendTo(files).data('file', data);
            }, function(res) {
                $.toast('show', '上传失败,请重新上传' + JSON.stringify(res));
            });
        }, function(res) {
            $.toast('show', '获取地理位置失败,请重新上传' + JSON.stringify(res));
        });
    });
}


function showMore() {
    var page = $('#main-page');
    if (page.hasClass('page_more')) {
        page.removeClass('page_more');
    } else {
        page.addClass('page_more');
    }
}

$(function() {
    //验证
    $('.validate').validate({
        // required: true
    });

    //支行查询
    $('#subbranch-searchbar').searchbar({
        onSearch: searchSubbrach
    });

    $('#subbranch-list').on('click', '.weui-cell', function() {
        $('#subbranch_name').val($(this).attr('data-text'));
        $('#subbranch-popup').popup('close');
    });

    //上传照片
    $('#detail-fm').on('click', '.weui-uploader__input', function() {
        var files = $(this).closest('.weui-uploader').find('.weui-uploader__files');
        uploadImage(['camera', 'album'], files);
    }).on('click', '.weui-uploader__file', function(argument) {
        var target = this;
        var data = $(target).data('file');
        $.gallery({
            deletable: query.operateType == 'view' ? false : true,
            imageUrl: data.file_url || data.localid,
            onDelete: function() {
                target.remove();
            }
        });
    });

    $$.request('/action/ms/parameter/list', {
        debit_fee_algo: '1',
        credit_fee_algo: '1',
        equi_type: '1',
        account_bank: '1'
    }, function(data) {
        if (data.errcode == 0) {
            $("#equi_type").select({
                title: '请选择机具类型',
                items: data.equi_type
            });

            $("#district").select({
                title: '请选择装机地区',
                items: district
            });

            $("#fee_algo").select({
                title: '请选择借记卡手续费',
                items: data.debit_fee_algo
            });

            $("#credit_fee_algo").select({
                title: '请选择贷记卡手续费',
                items: data.credit_fee_algo
            });
        }
    });


    if (query.operateType == 'create') {
        var data = $$.getData('detail');
        if (data) {
            loadDetailForm(data);
        }
    } else {
        $$.request('/action/ms/mchnt-busi/view', query, function(data) {
            if (data.errcode == 0) {
                loadDetailForm(data);
            }
        });
    }

    if (query.operateType == 'view') {
        $('#main-page').addClass('page_view').find('input').attr('disabled', 'disabled').removeAttr('placeholder');
    }
});
