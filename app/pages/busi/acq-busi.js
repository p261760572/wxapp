var district = [{ "text": "湖南省", "items": [{ "text": "长沙市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "芙蓉区", "value": "02" }, { "text": "天心区", "value": "03" }, { "text": "岳麓区", "value": "04" }, { "text": "开福区", "value": "05" }, { "text": "雨花区", "value": "11" }, { "text": "望城区", "value": "12" }, { "text": "长沙县", "value": "21" }, { "text": "宁乡县", "value": "24" }, { "text": "浏阳市", "value": "81" }], "value": "01" }, { "text": "株洲市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "荷塘区", "value": "02" }, { "text": "芦淞区", "value": "03" }, { "text": "石峰区", "value": "04" }, { "text": "天元区", "value": "11" }, { "text": "株洲县", "value": "21" }, { "text": "攸县", "value": "23" }, { "text": "茶陵县", "value": "24" }, { "text": "炎陵县", "value": "25" }, { "text": "醴陵市", "value": "81" }], "value": "02" }, { "text": "湘潭市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "雨湖区", "value": "02" }, { "text": "岳塘区", "value": "04" }, { "text": "湘潭县", "value": "21" }, { "text": "湘乡市", "value": "81" }, { "text": "韶山市", "value": "82" }], "value": "03" }, { "text": "衡阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "珠晖区", "value": "05" }, { "text": "雁峰区", "value": "06" }, { "text": "石鼓区", "value": "07" }, { "text": "蒸湘区", "value": "08" }, { "text": "南岳区", "value": "12" }, { "text": "衡阳县", "value": "21" }, { "text": "衡南县", "value": "22" }, { "text": "衡山县", "value": "23" }, { "text": "衡东县", "value": "24" }, { "text": "祁东县", "value": "26" }, { "text": "耒阳市", "value": "81" }, { "text": "常宁市", "value": "82" }], "value": "04" }, { "text": "邵阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "双清区", "value": "02" }, { "text": "大祥区", "value": "03" }, { "text": "北塔区", "value": "11" }, { "text": "邵东县", "value": "21" }, { "text": "新邵县", "value": "22" }, { "text": "邵阳县", "value": "23" }, { "text": "隆回县", "value": "24" }, { "text": "洞口县", "value": "25" }, { "text": "绥宁县", "value": "27" }, { "text": "新宁县", "value": "28" }, { "text": "城步苗族自治县", "value": "29" }, { "text": "武冈市", "value": "81" }], "value": "05" }, { "text": "岳阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "岳阳楼区", "value": "02" }, { "text": "云溪区", "value": "03" }, { "text": "君山区", "value": "11" }, { "text": "岳阳县", "value": "21" }, { "text": "华容县", "value": "23" }, { "text": "湘阴县", "value": "24" }, { "text": "平江县", "value": "26" }, { "text": "汨罗市", "value": "81" }, { "text": "临湘市", "value": "82" }], "value": "06" }, { "text": "常德市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "武陵区", "value": "02" }, { "text": "鼎城区", "value": "03" }, { "text": "安乡县", "value": "21" }, { "text": "汉寿县", "value": "22" }, { "text": "澧县", "value": "23" }, { "text": "临澧县", "value": "24" }, { "text": "桃源县", "value": "25" }, { "text": "石门县", "value": "26" }, { "text": "津市市", "value": "81" }], "value": "07" }, { "text": "张家界市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "永定区", "value": "02" }, { "text": "武陵源区", "value": "11" }, { "text": "慈利县", "value": "21" }, { "text": "桑植县", "value": "22" }], "value": "08" }, { "text": "益阳市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "资阳区", "value": "02" }, { "text": "赫山区", "value": "03" }, { "text": "南县", "value": "21" }, { "text": "桃江县", "value": "22" }, { "text": "安化县", "value": "23" }, { "text": "沅江市", "value": "81" }], "value": "09" }, { "text": "郴州市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "北湖区", "value": "02" }, { "text": "苏仙区", "value": "03" }, { "text": "桂阳县", "value": "21" }, { "text": "宜章县", "value": "22" }, { "text": "永兴县", "value": "23" }, { "text": "嘉禾县", "value": "24" }, { "text": "临武县", "value": "25" }, { "text": "汝城县", "value": "26" }, { "text": "桂东县", "value": "27" }, { "text": "安仁县", "value": "28" }, { "text": "资兴市", "value": "81" }], "value": "10" }, { "text": "永州市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "零陵区", "value": "02" }, { "text": "冷水滩区", "value": "03" }, { "text": "祁阳县", "value": "21" }, { "text": "东安县", "value": "22" }, { "text": "双牌县", "value": "23" }, { "text": "道县", "value": "24" }, { "text": "江永县", "value": "25" }, { "text": "宁远县", "value": "26" }, { "text": "蓝山县", "value": "27" }, { "text": "新田县", "value": "28" }, { "text": "江华瑶族自治县", "value": "29" }], "value": "11" }, { "text": "怀化市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "鹤城区", "value": "02" }, { "text": "中方县", "value": "21" }, { "text": "沅陵县", "value": "22" }, { "text": "辰溪县", "value": "23" }, { "text": "溆浦县", "value": "24" }, { "text": "会同县", "value": "25" }, { "text": "麻阳苗族自治县", "value": "26" }, { "text": "新晃侗族自治县", "value": "27" }, { "text": "芷江侗族自治县", "value": "28" }, { "text": "靖州苗族侗族自治县", "value": "29" }, { "text": "通道侗族自治县", "value": "30" }, { "text": "洪江市", "value": "81" }], "value": "12" }, { "text": "娄底市", "items": [{ "text": "市辖区", "value": "01" }, { "text": "娄星区", "value": "02" }, { "text": "双峰县", "value": "21" }, { "text": "新化县", "value": "22" }, { "text": "冷水江市", "value": "81" }, { "text": "涟源市", "value": "82" }], "value": "13" }, { "text": "湘西土家族苗族自治州", "items": [{ "text": "吉首市", "value": "01" }, { "text": "泸溪县", "value": "22" }, { "text": "凤凰县", "value": "23" }, { "text": "花垣县", "value": "24" }, { "text": "保靖县", "value": "25" }, { "text": "古丈县", "value": "26" }, { "text": "永顺县", "value": "27" }, { "text": "龙山县", "value": "30" }], "value": "31" }], "value": "43" }];

var query = $$.parseQueryString();
requiredWx();


function searchSubbrach() {
    var processing = false;
    var data = $(this).serializeObject();
    $('#subbranch-list').html('');
    $('#subbranch-list').pagination({
        url: $$.wrapUrl('/action/ms/bank-subbranch/list'),
        pageNumber: 1,
        queryParams: data,
        onLoadSuccess: function(data) {
            processing = false;
            var html = template('subbranch-templ', data);
            $('#subbranch-list').append(html);
        },
        onLoadError() {
            processing = false;
        }
    })

    $('#infinite').infinite().on('infinite', function() {
        if (!processing) {
            processing = true;
            $('#subbranch-list').pagination('next');
        }
    });;
}


$(function() {
    //验证
    $('.validate').validate({
        // required: true
    });

    //支行查询
    $('#subbranch-searchbar').searchbar({
        onSearch: searchSubbrach
    });

    $('#subbranch-list').on('click', 'a.weui-cell', function() {
        $('#subbranch_name').val($(this).attr('data-text'));
        $('#subbranch-popup').popup('close');
    });

    //上传照片
    $('#detail-fm').on('click', '.weui-uploader__input', function() {
        var files = $(this).closest('.weui-uploader').find('.weui-uploader__files');
        $.actionsheet({
            android: true,
            actions: [{
                text: '拍照',
                onClick: function() {
                    uploadImage('camera', files);
                }
            }, {
                text: '选择照片',
                onClick: function() {
                    uploadImage('album', files);
                }
            }]
        });
    });

    $$.request('/action/ms/parameter/list', {
        debit_fee_algo: '1',
        credit_fee_algo: '1',
        equi_type: '1',
        account_bank: '1'
    }, function(data) {
        if (data.errcode == 0) {
            $("#equi_type").select2({
                title: '请选择机具类型',
                items: data.equi_type
            });

            $("#district").select({
                title: '请选择装机地区',
                items: district
            });

            $("#fee_algo").select({
                title: '请选择借记卡手续费',
                items: data.debit_fee_algo
            });

            $("#credit_fee_algo").select({
                title: '请选择贷记卡手续费',
                items: data.credit_fee_algo
            });
        }
    });
});

//封装微信JS-SDK
function wxChooseImage(sourceType, success) {
    wx.chooseImage({
        count: 1, // 默认9
        sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
        sourceType: sourceType, // 可以指定来源是相册还是相机，默认二者都有 ['camera', 'album']
        success: function(res) {
            var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
            var localId = localIds[0];
            if (success) { success(localId); }
        }
    });
}

function wxLocation(success) {
    wx.getLocation({
        type: 'gcj02', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
        success: function(res) {
            var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
            var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
            var speed = res.speed; // 速度，以米/每秒计
            var accuracy = res.accuracy || null; // 位置精度
            if (success) {
                success({
                    latitude: latitude,
                    longitude: longitude
                });
            }
        }
    });
}

function uploadImage(localId, success, error) {
    wx.uploadImage({
        localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
        isShowProgressTips: 1, // 默认为1，显示进度提示
        success: function(res) {
            var serverId = res.serverId; // 返回图片的服务器端ID
            if (success) { success(serverId); }
        },
        fail: function(res) {
            // $.toast('show', '上传失败,' + JSON.stringify(res));
            if (error) { error(res); }
        }
    });
}

function serializeForm(argument) {
    // body...
}

function serializeDetailForm(target, eiTypeMap) {
    var data = $(target).serializeObject();
    data.apptype = '105';
    data.license_no = data.license_no.toUpperCase();

    //照片处理
    var eiType = ['01', '02', '03', '04', '16', '17'];
    $.each(eiType, function(index, item) {
        eiTypeMap[item] = 0;
    });
    var images = [];
    for (var i = 0; i < eiType.length; i++) {
        var type = eiType[i];
        var container = $('#' + type).children('.weui_uploader_file').each(function(index, item) {
            var fileData = $(item).data('file');

            $.extend(fileData, {
                'ei_type': type
            });

            images.push($.extend(fileData, {
                'ei_type': type
            }));

            eiTypeMap[type]++;
        });
    }
    data.images = images;

    return data;
}


function save(argument) {
    var isValid = $('#detail-fm').form('validate');
    var eiTypeMap = {};
    var data = serializeForm('#detail-fm', eiTypeMap);
    $$.setData('detail', data);
    $.toast('暂存成功');
}


function submit(argument) {
    // e.preventDefault();
    window.localStorage.setItem(DETAIL_KEY, '');
    //$.toast("操作成功");
    var eiTypeMap = {};
    var data = serializeDetailForm(this, eiTypeMap);

    var required = true;
    $(this).find('input[required="required"]').each(function(index, item) {
        if (!$(item).val()) {
            required = false;
            $(item).focus();
        }
    });

    if (!required) {
        alert('请填写必输入项');
        return false;
    }

    if (eiTypeMap['01'] < 1) {
        alert('请上传营业执照照片');
        return false;
    }

    if (eiTypeMap['03'] < 1) {
        alert('请上传法人身份证照片');
        return false;
    }

    if (eiTypeMap['16'] < 1) {
        alert('请上传结算账户(银行卡)照片');
        return false;
    }

    var url = '/action/ms/mchnt-busi/create';
    if (query.operateType == 'update') {
        url = '/action/ms/mchnt-busi/update';
    }
    send(url, data, function(data) {
        if (data.errcode == 0) {
            submitSuccess = true;
            window.location.href = 'msg.html';
        }
    });
}


function uploadImage(sourceType, files) {
    wxChooseImage(sourceType, function(localId) {

    });
}
